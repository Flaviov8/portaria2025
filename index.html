<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Login - Vivace Campo Limpo Encomendas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Reset e Estilos Globais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-image: url('vivace.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Login Page */
        .login-container {
            max-width: 450px;
            margin: 5% auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            margin-bottom: 2rem;
        }

        .logo img {
            width: 100px;
            height: auto;
            margin-bottom: 1rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .input-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .input-group input:focus {
            border-color: #3498db;
            outline: none;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: rgb(241, 237, 237);
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-login:hover {
            background-color: #2980b9;
        }

        .footer {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #777;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .success-message {
            color: #2ecc71;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .auth-links {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
        }

        .auth-links a {
            color: #3498db;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
        }

        .auth-links a:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-footer {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: rgb(243, 243, 243);
            border: none;
        }

        .btn-primary:hover {
            background-color: #3398db;
        }

        .btn-secondary {
            background-color: #23e47a;
            color: #eaeef3;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #bdc3c7;
        }

        /* Página Principal (oculta inicialmente) */
        #mainApp {
            display: none;
        }

        /* Admin Section */
        .admin-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .admin-section h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .user-table th, .user-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .user-table th {
            background-color: #3498db;
            color: white;
        }

        .user-table tr:hover {
            background-color: #f1f1f1;
        }

        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginPage">
        <div class="login-container">
            <div class="logo">
                <img src="logovivace.png" alt="Logo Vivace">
                <h1>Vivace Portaria</h1>
            </div>
            
            <form id="loginForm">
                <div class="input-group">
                    <label for="username"><i class="fas fa-user"></i> Usuário</label>
                    <input type="text" id="username" placeholder="Digite seu usuário" required>
                </div>
                
                <div class="input-group">
                    <label for="password"><i class="fas fa-lock"></i> Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
                
                <div class="error-message" id="errorMessage">
                    Usuário ou senha incorretos. Tente novamente.
                </div>
                
                <div class="success-message" id="successMessage">
                    Operação realizada com sucesso!
                </div>
                
                <div class="auth-links">
                    <a href="#" id="forgotPasswordLink">Esqueci minha senha</a>
                    <a href="#" id="registerLink">Cadastrar novo usuário</a>
                </div>
            </form>
            
            <div class="footer">
                Sistema de Controle de Encomendas &copy; <span id="currentYear"></span>
            </div>
        </div>
    </div>

    <!-- Modal de Redefinição de Senha -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Redefinir Senha</h2>
                <button class="close-btn" id="closeForgotPasswordModal">&times;</button>
            </div>
            <form id="forgotPasswordForm">
                <div class="input-group">
                    <label for="resetUsername">Usuário</label>
                    <input type="text" id="resetUsername" placeholder="Digite seu usuário" required>
                </div>
                <div class="input-group">
                    <label for="resetEmail">E-mail cadastrado</label>
                    <input type="email" id="resetEmail" placeholder="Digite seu e-mail" required>
                </div>
                <div class="input-group">
                    <label for="newPassword">Nova Senha</label>
                    <input type="password" id="newPassword" placeholder="Digite a nova senha" required>
                </div>
                <div class="input-group">
                    <label for="confirmNewPassword">Confirmar Nova Senha</label>
                    <input type="password" id="confirmNewPassword" placeholder="Confirme a nova senha" required>
                </div>
                <div class="error-message" id="resetErrorMessage"></div>
                <div class="success-message" id="resetSuccessMessage"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelResetPassword">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Redefinir Senha</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro de Usuário -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cadastrar Novo Usuário</h2>
                <button class="close-btn" id="closeRegisterModal">&times;</button>
            </div>
            <form id="registerForm">
                <div class="input-group">
                    <label for="registerUsername">Usuário</label>
                    <input type="text" id="registerUsername" placeholder="Digite um nome de usuário" required>
                </div>
                <div class="input-group">
                    <label for="registerName">Nome Completo</label>
                    <input type="text" id="registerName" placeholder="Digite o nome completo" required>
                </div>
                <div class="input-group">
                    <label for="registerEmail">E-mail</label>
                    <input type="email" id="registerEmail" placeholder="Digite o e-mail" required>
                </div>
                <div class="input-group">
                    <label for="registerPassword">Senha</label>
                    <input type="password" id="registerPassword" placeholder="Digite a senha" required>
                </div>
                <div class="input-group">
                    <label for="registerConfirmPassword">Confirmar Senha</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirme a senha" required>
                </div>
                <div class="input-group">
                    <label for="registerRole">Tipo de Usuário</label>
                    <select id="registerRole" required>
                        <option value="">Selecione...</option>
                        <option value="Portaria">Portaria</option>
                        <option value="Administrador">Administrador</option>
                        <option value="Zeladoria">Zeladoria</option>
                    </select>
                </div>
                <div class="error-message" id="registerErrorMessage"></div>
                <div class="success-message" id="registerSuccessMessage"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelRegister">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Aplicação Principal (oculta inicialmente) -->
    <div id="mainApp">
        <header>
            <div class="header-container">
                <img src="logovivace.png" alt="Logo" class="logo">
                <h1>Registro de Encomendas Vivace</h1>
                <nav>
                    <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </nav>
            </div>
        </header>
        
        <main>
            <div class="container">
                <form id="encomendaForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transportadora"><i class="fas fa-truck"></i> Transportadora</label>
                            <select id="transportadora" required>
                                <option value="">Selecione...</option>
                                <option value="Correios">Correios</option>
                                <option value="Mercado Livre">Mercado Livre</option>
                                <option value="Amazon">Amazon</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="data"><i class="far fa-calendar-alt"></i> Data</label>
                            <input type="datetime-local" id="data" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="apartamento"><i class="fas fa-building"></i> Apartamento</label>
                            <input type="text" id="apartamento" placeholder="Número do apto" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="morador"><i class="fas fa-user"></i> Morador</label>
                            <input type="text" id="morador" placeholder="Nome do morador" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="telefone"><i class="fas fa-phone"></i> Telefone (WhatsApp)</label>
                            <input type="tel" id="telefone" placeholder="(00) 00000-0000" required>
                            <small class="hint">Formato: (DDD) 99999-9999</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipo-encomenda"><i class="fas fa-box"></i> Tipo de Encomenda</label>
                            <select id="tipo-encomenda">
                                <option value="Pequena">Pequena</option>
                                <option value="Média">Média</option>
                                <option value="Grande">Grande</option>
                                <option value="Frágil">Frágil</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes"><i class="fas fa-edit"></i> Observações</label>
                        <textarea id="observacoes" rows="3" placeholder="Detalhes da encomenda, número de rastreamento, etc."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="foto"><i class="fas fa-camera"></i> Foto da Encomenda (opcional)</label>
                            <input type="file" id="foto" accept="image/*">
                        </div>
                        
                        <div class="form-group">
                            <label for="local-armazenamento"><i class="fas fa-archive"></i> Local de Armazenamento</label>
                            <select id="local-armazenamento">
                                <option value="Portaria">Portaria</option>
                                <option value="Depósito">Depósito</option>
                                <option value="Sala de Encomendas">Sala de Encomendas</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i> Registrar e Notificar
                        </button>
                        <button type="button" id="notificarBtn" class="btn-secondary">
                            <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                        </button>
                        <button type="reset" class="btn-cancel">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </form>
                
                <!-- Seção de Administração (visível apenas para administradores) -->
                <div id="adminSection" class="admin-section" style="display: none;">
                    <h2><i class="fas fa-users-cog"></i> Gerenciamento de Usuários</h2>
                    <button id="addUserBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Adicionar Usuário
                    </button>
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Usuário</th>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>E-mail</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Dados serão preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="recent-entries">
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Registros Recentes</h2>
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Buscar encomendas...">
                            <button id="searchBtn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="recentTable">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Transportadora</th>
                                    <th>Apto</th>
                                    <th>Morador</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="table-info">
                            Mostrando <span id="showingCount">0</span> de <span id="totalCount">0</span> registros
                        </div>
                        <div class="pagination">
                            <button id="prevPage"><i class="fas fa-chevron-left"></i></button>
                            <span id="currentPage">1</span>
                            <button id="nextPage"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="footer-content">
                <p>Sistema de Controle de Encomendas &copy; <span id="currentYearMain"></span></p>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-question-circle"></i> Ajuda</a>
                    <a href="#"><i class="fas fa-cog"></i> Configurações</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Credenciais válidas (em produção, isso deve ser substituído por autenticação segura no servidor)
        let validUsers = JSON.parse(localStorage.getItem('validUsers')) || [
            { username: 'portaria', password: 'vivace123', name: 'Portaria', email: 'portaria@vivace.com', role: 'Portaria' },
            { username: 'admin', password: 'admin123', name: 'Administrador', email: 'admin@vivace.com', role: 'Administrador' },
            { username: 'zelador', password: 'zelador123', name: 'Zeladoria', email: 'zelador@vivace.com', role: 'Zeladoria' }
        ];

        // Elementos da tela de login
        const loginPage = document.getElementById('loginPage');
        const loginForm = document.getElementById('loginForm');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const mainApp = document.getElementById('mainApp');

        // Elementos de redefinição de senha
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const closeForgotPasswordModal = document.getElementById('closeForgotPasswordModal');
        const cancelResetPassword = document.getElementById('cancelResetPassword');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const resetErrorMessage = document.getElementById('resetErrorMessage');
        const resetSuccessMessage = document.getElementById('resetSuccessMessage');

        // Elementos de cadastro de usuário
        const registerLink = document.getElementById('registerLink');
        const registerModal = document.getElementById('registerModal');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const cancelRegister = document.getElementById('cancelRegister');
        const registerForm = document.getElementById('registerForm');
        const registerErrorMessage = document.getElementById('registerErrorMessage');
        const registerSuccessMessage = document.getElementById('registerSuccessMessage');
        const addUserBtn = document.getElementById('addUserBtn');

        // Atualizar ano no footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        document.getElementById('currentYearMain').textContent = new Date().getFullYear();

        // Evento de login
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Verificar credenciais
            const user = validUsers.find(u => u.username === username && u.password === password);
            
            if (user) {
                // Login bem-sucedido
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                
                // Armazenar informações do usuário (em produção, usar métodos mais seguros)
                sessionStorage.setItem('loggedIn', 'true');
                sessionStorage.setItem('username', user.username);
                sessionStorage.setItem('userRole', user.role);
                sessionStorage.setItem('userName', user.name);
                
                // Inicializar a aplicação principal
                initializeApp();
            } else {
                // Login falhou
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }
        });

        // Verificar se já está logado ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('loggedIn') === 'true') {
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                initializeApp();
            }
            
            // Salvar usuários padrão se não existirem
            if (!localStorage.getItem('validUsers')) {
                localStorage.setItem('validUsers', JSON.stringify(validUsers));
            }
        });

        // Botão de logout
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            sessionStorage.removeItem('loggedIn');
            sessionStorage.removeItem('username');
            sessionStorage.removeItem('userRole');
            sessionStorage.removeItem('userName');
            window.location.reload();
        });

        // Redefinição de senha
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            forgotPasswordModal.style.display = 'flex';
            resetErrorMessage.style.display = 'none';
            resetSuccessMessage.style.display = 'none';
        });

        closeForgotPasswordModal.addEventListener('click', function() {
            forgotPasswordModal.style.display = 'none';
            forgotPasswordForm.reset();
        });

        cancelResetPassword.addEventListener('click', function() {
            forgotPasswordModal.style.display = 'none';
            forgotPasswordForm.reset();
        });

        forgotPasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('resetUsername').value;
            const email = document.getElementById('resetEmail').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            resetErrorMessage.style.display = 'none';
            resetSuccessMessage.style.display = 'none';
            
            // Validar senhas
            if (newPassword !== confirmNewPassword) {
                resetErrorMessage.textContent = 'As senhas não coincidem.';
                resetErrorMessage.style.display = 'block';
                return;
            }
            
            // Verificar se o usuário existe
            const userIndex = validUsers.findIndex(u => u.username === username && u.email === email);
            
            if (userIndex === -1) {
                resetErrorMessage.textContent = 'Usuário ou e-mail não encontrados.';
                resetErrorMessage.style.display = 'block';
                return;
            }
            
            // Atualizar senha
            validUsers[userIndex].password = newPassword;
            localStorage.setItem('validUsers', JSON.stringify(validUsers));
            
            // Mostrar mensagem de sucesso
            resetSuccessMessage.textContent = 'Senha redefinida com sucesso!';
            resetSuccessMessage.style.display = 'block';
            
            // Limpar formulário e fechar modal após 2 segundos
            setTimeout(() => {
                forgotPasswordForm.reset();
                forgotPasswordModal.style.display = 'none';
            }, 2000);
        });

        // Cadastro de usuário
        registerLink.addEventListener('click', function(e) {
            e.preventDefault();
            registerModal.style.display = 'flex';
            registerErrorMessage.style.display = 'none';
            registerSuccessMessage.style.display = 'none';
        });

        closeRegisterModal.addEventListener('click', function() {
            registerModal.style.display = 'none';
            registerForm.reset();
        });

        cancelRegister.addEventListener('click', function() {
            registerModal.style.display = 'none';
            registerForm.reset();
        });

        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const role = document.getElementById('registerRole').value;
            
            registerErrorMessage.style.display = 'none';
            registerSuccessMessage.style.display = 'none';
            
            // Validar campos
            if (password !== confirmPassword) {
                registerErrorMessage.textContent = 'As senhas não coincidem.';
                registerErrorMessage.style.display = 'block';
                return;
            }
            
            if (!username || !name || !email || !password || !role) {
                registerErrorMessage.textContent = 'Preencha todos os campos.';
                registerErrorMessage.style.display = 'block';
                return;
            }
            
            // Verificar se o usuário já existe
            const userExists = validUsers.some(u => u.username === username);
            
            if (userExists) {
                registerErrorMessage.textContent = 'Nome de usuário já existe. Escolha outro.';
                registerErrorMessage.style.display = 'block';
                return;
            }
            
            // Criar novo usuário
            const newUser = {
                username,
                password,
                name,
                email,
                role
            };
            
            validUsers.push(newUser);
            localStorage.setItem('validUsers', JSON.stringify(validUsers));
            
            // Mostrar mensagem de sucesso
            registerSuccessMessage.textContent = 'Usuário cadastrado com sucesso!';
            registerSuccessMessage.style.display = 'block';
            
            // Limpar formulário e fechar modal após 2 segundos
            setTimeout(() => {
                registerForm.reset();
                registerModal.style.display = 'none';
            }, 2000);
        });

        // Inicializar a aplicação principal
        function initializeApp() {
            // Mostrar seção de administração apenas para administradores
            const userRole = sessionStorage.getItem('userRole');
            if (userRole === 'Administrador') {
                document.getElementById('adminSection').style.display = 'block';
                carregarUsuarios();
            }

            // Configurações de notificação
            const notificationConfig = {
                emailEnabled: false,
                whatsappEnabled: true,
                emailApiKey: '',
                whatsappApiKey: ''
            };

            // Dados simulados
            let encomendas = JSON.parse(localStorage.getItem('encomendas')) || [];

            // Máscara para telefone
            document.getElementById('telefone')?.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                if (value.length > 2) {
                    value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
                }
                
                if (value.length > 10) {
                    value = `${value.substring(0, 10)}-${value.substring(10)}`;
                }
                
                e.target.value = value;
            });

            // Função para carregar usuários na tabela
            function carregarUsuarios() {
                const usersTableBody = document.getElementById('usersTableBody');
                if (!usersTableBody) return;
                
                usersTableBody.innerHTML = '';
                
                validUsers.forEach(user => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.role}</td>
                        <td>${user.email}</td>
                        <td class="action-btns">
                            <button class="btn btn-primary btn-sm edit-user" data-username="${user.username}">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            ${user.role !== 'Administrador' ? 
                            `<button class="btn btn-danger btn-sm delete-user" data-username="${user.username}">
                                <i class="fas fa-trash"></i> Excluir
                            </button>` : ''}
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
                
                // Adicionar eventos aos botões
                document.querySelectorAll('.edit-user').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        editarUsuario(username);
                    });
                });
                
                document.querySelectorAll('.delete-user').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        if (confirm(`Tem certeza que deseja excluir o usuário ${username}?`)) {
                            excluirUsuario(username);
                        }
                    });
                });
            }

            // Função para editar usuário
            function editarUsuario(username) {
                const user = validUsers.find(u => u.username === username);
                if (!user) return;
                
                // Preencher modal de cadastro com dados do usuário
                document.getElementById('registerUsername').value = user.username;
                document.getElementById('registerName').value = user.name;
                document.getElementById('registerEmail').value = user.email;
                document.getElementById('registerRole').value = user.role;
                
                // Mostrar modal
                registerModal.style.display = 'flex';
                registerErrorMessage.style.display = 'none';
                registerSuccessMessage.style.display = 'none';
                
                // Alterar comportamento do formulário para edição
                registerForm.onsubmit = function(e) {
                    e.preventDefault();
                    
                    const newName = document.getElementById('registerName').value;
                    const newEmail = document.getElementById('registerEmail').value;
                    const newPassword = document.getElementById('registerPassword').value;
                    const confirmPassword = document.getElementById('registerConfirmPassword').value;
                    const newRole = document.getElementById('registerRole').value;
                    
                    registerErrorMessage.style.display = 'none';
                    registerSuccessMessage.style.display = 'none';
                    
                    // Validar senhas se for alteração
                    if (newPassword && newPassword !== confirmPassword) {
                        registerErrorMessage.textContent = 'As senhas não coincidem.';
                        registerErrorMessage.style.display = 'block';
                        return;
                    }
                    
                    // Atualizar usuário
                    user.name = newName;
                    user.email = newEmail;
                    user.role = newRole;
                    
                    if (newPassword) {
                        user.password = newPassword;
                    }
                    
                    localStorage.setItem('validUsers', JSON.stringify(validUsers));
                    
                    // Mostrar mensagem de sucesso
                    registerSuccessMessage.textContent = 'Usuário atualizado com sucesso!';
                    registerSuccessMessage.style.display = 'block';
                    
                    // Limpar formulário e fechar modal após 2 segundos
                    setTimeout(() => {
                        registerForm.reset();
                        registerModal.style.display = 'none';
                        carregarUsuarios();
                        registerForm.onsubmit = registerFormDefaultSubmit; // Restaurar comportamento padrão
                    }, 2000);
                };
            }

            // Função para excluir usuário
            function excluirUsuario(username) {
                validUsers = validUsers.filter(u => u.username !== username);
                localStorage.setItem('validUsers', JSON.stringify(validUsers));
                carregarUsuarios();
            }

            // Comportamento padrão do formulário de cadastro
            function registerFormDefaultSubmit(e) {
                e.preventDefault();
                
                const username = document.getElementById('registerUsername').value;
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const role = document.getElementById('registerRole').value;
                
                registerErrorMessage.style.display = 'none';
                registerSuccessMessage.style.display = 'none';
                
                // Validar campos
                if (password !== confirmPassword) {
                    registerErrorMessage.textContent = 'As senhas não coincidem.';
                    registerErrorMessage.style.display = 'block';
                    return;
                }
                
                if (!username || !name || !email || !password || !role) {
                    registerErrorMessage.textContent = 'Preencha todos os campos.';
                    registerErrorMessage.style.display = 'block';
                    return;
                }
                
                // Verificar se o usuário já existe
                const userExists = validUsers.some(u => u.username === username);
                
                if (userExists) {
                    registerErrorMessage.textContent = 'Nome de usuário já existe. Escolha outro.';
                    registerErrorMessage.style.display = 'block';
                    return;
                }
                
                // Criar novo usuário
                const newUser = {
                    username,
                    password,
                    name,
                    email,
                    role
                };
                
                validUsers.push(newUser);
                localStorage.setItem('validUsers', JSON.stringify(validUsers));
                
                // Mostrar mensagem de sucesso
                registerSuccessMessage.textContent = 'Usuário cadastrado com sucesso!';
                registerSuccessMessage.style.display = 'block';
                
                // Limpar formulário e fechar modal após 2 segundos
                setTimeout(() => {
                    registerForm.reset();
                    registerModal.style.display = 'none';
                    carregarUsuarios();
                }, 2000);
            }

            // Botão para adicionar usuário (na área administrativa)
            addUserBtn?.addEventListener('click', function() {
                registerForm.reset();
                registerModal.style.display = 'flex';
                registerErrorMessage.style.display = 'none';
                registerSuccessMessage.style.display = 'none';
                registerForm.onsubmit = registerFormDefaultSubmit;
            });

            // Função para enviar notificação
            function sendNotification(to, message) {
                if(notificationConfig.whatsappEnabled) {
                    sendWhatsAppNotification(to, message);
                }
                
                if(notificationConfig.emailEnabled) {
                    sendEmailNotification(to, message);
                }
            }

            // Função para enviar mensagem pelo WhatsApp
            function sendWhatsAppNotification(phone, message) {
                // Limpar formatação do telefone
                const cleanedPhone = phone.replace(/\D/g, '');
                
                // Verificar se tem DDI (código do país)
                let finalPhone = cleanedPhone;
                if (!cleanedPhone.startsWith('55') && cleanedPhone.length === 11) {
                    finalPhone = `55${cleanedPhone}`;
                }
                
                // Codificar a mensagem para URL
                const encodedMessage = encodeURIComponent(message);
                
                // Criar link do WhatsApp
                const whatsappUrl = `https://wa.me/${finalPhone}?text=${encodedMessage}`;
                
                // Abrir em nova aba (para teste)
                window.open(whatsappUrl, '_blank');
            }

            // Simulação de envio por e-mail (em produção, usar API como SendGrid)
            function sendEmailNotification(email, message) {
                console.log(`Enviando e-mail para ${email}: ${message}`);
                // Em produção, integrar com API de e-mail
            }

            // Formulário de registro
            document.getElementById('encomendaForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const transportadora = document.getElementById('transportadora').value;
                const data = document.getElementById('data').value;
                const apartamento = document.getElementById('apartamento').value;
                const morador = document.getElementById('morador').value;
                const telefone = document.getElementById('telefone').value;
                const tipoEncomenda = document.getElementById('tipo-encomenda').value;
                const localArmazenamento = document.getElementById('local-armazenamento').value;
                const observacoes = document.getElementById('observacoes').value;
                
                const novaEncomenda = {
                    id: Date.now(),
                    transportadora,
                    data: new Date(data).toLocaleString(),
                    apartamento,
                    morador,
                    telefone,
                    tipoEncomenda,
                    localArmazenamento,
                    observacoes,
                    status: 'pendente',
                    notificado: false,
                    dataRegistro: new Date().toISOString(),
                    registradoPor: sessionStorage.getItem('username')
                };
                
                encomendas.unshift(novaEncomenda);
                localStorage.setItem('encomendas', JSON.stringify(encomendas));
                
                // Criar mensagem de notificação
                const message = `📦 *Notificação de Encomenda* 📦\n\n` +
                               `Olá ${morador},\n` +
                               `Você possui uma encomenda aguardando retirada na portaria do condomínio Vivace. Solicitamos que faça a retirada o quanto antes.\n\n` +
                               `*Detalhes:*\n` +
                               `- Transportadora: ${transportadora}\n` +
                               `- Tipo: ${tipoEncomenda}\n` +
                               `- Apartamento: ${apartamento}\n` +
                               `- Data: ${new Date(data).toLocaleString()}\n` +
                               `- Local: ${localArmazenamento}\n` +
                               `- Observações: ${observacoes || 'Nenhuma'}\n\n` +
                               `Por favor, retire na portaria.`;
                
                // Enviar notificação
                sendWhatsAppNotification(telefone, message);
                
                alert('Encomenda registrada e morador notificado via WhatsApp!');
                carregarRegistrosRecentes();
            });

            // Notificação imediata via WhatsApp
            document.getElementById('notificarBtn')?.addEventListener('click', function() {
                const apartamento = document.getElementById('apartamento').value;
                const morador = document.getElementById('morador').value;
                const telefone = document.getElementById('telefone').value;
                
                if(!apartamento || !morador || !telefone) {
                    alert('Preencha todos os campos antes de notificar.');
                    return;
                }
                
                const transportadora = document.getElementById('transportadora').value || 'Transportadora não informada';
                const tipoEncomenda = document.getElementById('tipo-encomenda').value || 'Tipo não informado';
                const localArmazenamento = document.getElementById('local-armazenamento').value || 'Local não informado';
                const observacoes = document.getElementById('observacoes').value || 'Nenhuma observação';
                
                const message = `📦 *Notificação de Encomenda* 📦\n\n` +
                               `Olá ${morador},\n` +
                               `Você possui uma encomenda aguardando retirada na portaria do condomínio Vivace. Solicitamos que faça a retirada o quanto antes.\n\n` +
                               `*Detalhes:*\n` +
                               `- Transportadora: ${transportadora}\n` +
                               `- Tipo: ${tipoEncomenda}\n` +
                               `- Apartamento: ${apartamento}\n` +
                               `- Local: ${localArmazenamento}\n` +
                               `- Observações: ${observacoes}\n\n` +
                               `Por favor, retire na portaria.`;
                
                sendWhatsAppNotification(telefone, message);
            });

            // Carregar registros recentes
            function carregarRegistrosRecentes() {
                const tableBody = document.getElementById('recentTable')?.querySelector('tbody');
                if(!tableBody) return;
                
                tableBody.innerHTML = '';
                
                // Ordenar por data de registro (mais recentes primeiro)
                const encomendasOrdenadas = [...encomendas].sort((a, b) => 
                    new Date(b.dataRegistro) - new Date(a.dataRegistro));
                
                // Mostrar apenas os 10 mais recentes
                const recentes = encomendasOrdenadas.slice(0, 10);
                
                recentes.forEach(encomenda => {
                    const row = document.createElement('tr');
                    
                    // Ícone de status
                    let statusIcon = '';
                    if(encomenda.notificado) {
                        statusIcon = `<span class="status-notificado"><i class="fas fa-check-circle"></i> Notificado</span>`;
                    } else {
                        statusIcon = `<span class="status-pendente"><i class="fas fa-clock"></i> Pendente</span>`;
                    }
                    
                    row.innerHTML = `
                        <td>${encomenda.data}</td>
                        <td>${encomenda.transportadora}</td>
                        <td>${encomenda.apartamento}</td>
                        <td>${encomenda.morador}</td>
                        <td>${statusIcon}</td>
                        <td>
                            <button class="action-btn view" data-id="${encomenda.id}">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="action-btn notify" data-id="${encomenda.id}">
                                <i class="fab fa-whatsapp"></i> Notificar
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Atualizar contadores
                document.getElementById('showingCount').textContent = recentes.length;
                document.getElementById('totalCount').textContent = encomendas.length;
                
                // Adicionar eventos aos botões
                document.querySelectorAll('.action-btn.view').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        visualizarEncomenda(id);
                    });
                });
                
                document.querySelectorAll('.action-btn.notify').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        notificarMorador(id);
                    });
                });
            }

            // Visualizar encomenda
            function visualizarEncomenda(id) {
                const encomenda = encomendas.find(e => e.id === id);
                if(encomenda) {
                    alert(`📦 Detalhes da Encomenda 📦\n\n` +
                          `Transportadora: ${encomenda.transportadora}\n` +
                          `Tipo: ${encomenda.tipoEncomenda}\n` +
                          `Data/Hora: ${encomenda.data}\n` +
                          `Apartamento: ${encomenda.apartamento}\n` +
                          `Morador: ${encomenda.morador}\n` +
                          `Telefone: ${encomenda.telefone || 'Não informado'}\n` +
                          `Local de Armazenamento: ${encomenda.localArmazenamento}\n` +
                          `Status: ${encomenda.notificado ? 'Notificado' : 'Pendente'}\n` +
                          `Registrado por: ${encomenda.registradoPor || 'Sistema'}\n` +
                          `Observações: ${encomenda.observacoes || 'Nenhuma'}`);
                }
            }

            // Notificar morador específico
            function notificarMorador(id) {
                const encomenda = encomendas.find(e => e.id === id);
                if(!encomenda) return;
                
                const message = `📦 *Lembrete de Encomenda* 📦\n\n` +
                               `Olá ${encomenda.morador},\n` +
                               `Você possui uma encomenda aguardando retirada na portaria do condomínio Vivace. Solicitamos que faça a retirada o quanto antes.\n\n` +
                               `*Detalhes:*\n` +
                               `- Transportadora: ${encomenda.transportadora}\n` +
                               `- Tipo: ${encomenda.tipoEncomenda}\n` +
                               `- Apartamento: ${encomenda.apartamento}\n` +
                               `- Data: ${encomenda.data}\n` +
                               `- Local: ${encomenda.localArmazenamento}\n` +
                               `- Observações: ${encomenda.observacoes || 'Nenhuma'}\n\n` +
                               `Por favor, retire na portaria.`;
                
                if(confirm(`Enviar lembrete para ${encomenda.morador} (Apto ${encomenda.apartamento}) via WhatsApp?`)) {
                    sendWhatsAppNotification(encomenda.telefone, message);
                    
                    // Atualizar status
                    encomenda.notificado = true;
                    encomenda.status = 'notificado';
                    localStorage.setItem('encomendas', JSON.stringify(encomendas));
                    carregarRegistrosRecentes();
                }
            }

            // Inicialização
            document.addEventListener('DOMContentLoaded', function() {
                // Definir data/hora atual como padrão
                const now = new Date();
                const dataInput = document.getElementById('data');
                if(dataInput) {
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    
                    dataInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
                
                // Carregar registros
                carregarRegistrosRecentes();
                
                // Configurar busca
                document.getElementById('searchBtn')?.addEventListener('click', function() {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    if(searchTerm) {
                        const resultados = encomendas.filter(encomenda => 
                            encomenda.morador.toLowerCase().includes(searchTerm) || 
                            encomenda.apartamento.toLowerCase().includes(searchTerm) ||
                            encomenda.transportadora.toLowerCase().includes(searchTerm)
                        );
                        exibirResultadosBusca(resultados);
                    } else {
                        carregarRegistrosRecentes();
                    }
                });
            });

            // Exibir resultados da busca
            function exibirResultadosBusca(resultados) {
                const tableBody = document.getElementById('recentTable').querySelector('tbody');
                tableBody.innerHTML = '';
                
                resultados.forEach(encomenda => {
                    const row = document.createElement('tr');
                    
                    let statusIcon = encomenda.notificado ? 
                        `<span class="status-notificado"><i class="fas fa-check-circle"></i> Notificado</span>` :
                        `<span class="status-pendente"><i class="fas fa-clock"></i> Pendente</span>`;
                    
                    row.innerHTML = `
                        <td>${encomenda.data}</td>
                        <td>${encomenda.transportadora}</td>
                        <td>${encomenda.apartamento}</td>
                        <td>${encomenda.morador}</td>
                        <td>${statusIcon}</td>
                        <td>
                            <button class="action-btn view" data-id="${encomenda.id}">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="action-btn notify" data-id="${encomenda.id}">
                                <i class="fab fa-whatsapp"></i> Notificar
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                document.getElementById('showingCount').textContent = resultados.length;
                document.getElementById('totalCount').textContent = encomendas.length;
            }
        }
    </script>
</body>
</html>